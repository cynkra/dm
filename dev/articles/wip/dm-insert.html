<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Updating tables and dm objects • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/Fira_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Updating tables and dm objects">
<meta name="robots" content="noindex">
<script defer data-domain="dm.cynkra.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-nav" alt="cynkra"></a>
    <a class="navbar-brand me-2" href="../../index.html">dm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.11.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../articles/dm.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../../articles/howto-dm-theory.html">Introduction to relational data models</a></li>
    <li><a class="dropdown-item" href="../../articles/howto-dm-df.html">Create a dm object from data frames</a></li>
    <li><a class="dropdown-item" href="../../articles/howto-dm-db.html">Create a dm object from a database</a></li>
    <li><a class="dropdown-item" href="../../articles/howto-dm-copy.html">Copy data to and from a database</a></li>
    <li><a class="dropdown-item" href="../../articles/howto-dm-rows.html">Insert, update, or remove rows in a database</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../articles/cheatsheet.html">Cheatsheet</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical-articles">
<li><a class="dropdown-item" href="../../articles/tech-dm-draw.html">Visualizing dm objects</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-keyed.html">Manipulating individual tables</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-join.html">Joining in relational data models</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-filter.html">Filtering in relational data models</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-zoom.html">Zooming and manipulating tables</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-low-level.html">Model verification - keys, constraints and normalization</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-class.html">Class 'dm' and basic operations</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-naming.html">Function naming logic</a></li>
    <li><a class="dropdown-item" href="../../articles/tech-dm-cdm.html">Migration guide: 'cdm' -&gt; 'dm'</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cynkra/dm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Updating tables and dm objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cynkra/dm/blob/main/vignettes/wip/dm-insert.Rmd" class="external-link"><code>vignettes/wip/dm-insert.Rmd</code></a></small>
      <div class="d-none name"><code>dm-insert.Rmd</code></div>
    </div>

    
    
<p>This draft describes update operations on tables and dm objects. The
generics for the table operations can be private in dm for now and move
to dplyr later. Contains parts from <a href="https://github.com/tidyverse/dplyr/issues/4654" class="external-link uri">https://github.com/tidyverse/dplyr/issues/4654</a>.</p>
<div class="section level2">
<h2 id="tables">Tables<a class="anchor" aria-label="anchor" href="#tables"></a>
</h2>
<p>In dplyr, operations on tables in dplyr are generally transient or
ephemeral. Resulting table objects must be stored in a new object,
otherwise they are lost. All operations by default return a new table
object that is disconnected from the original.</p>
<div class="section level3">
<h3 id="operations">Operations<a class="anchor" aria-label="anchor" href="#operations"></a>
</h3>
<p>The operations are modeled after existing database statements, with
the exception of the new “patch”.</p>
<ul>
<li><p>insert new rows — would error if keys already exist, similar to
<code><a href="https://tibble.tidyverse.org/reference/add_row.html" class="external-link">tibble::add_row()</a></code>.</p></li>
<li><p>update values — overrides existing values. (Similar to <a href="https://github.com/tidyverse/tidyr/issues/183" class="external-link uri">https://github.com/tidyverse/tidyr/issues/183</a>)</p></li>
<li><p>patch values — like update, but only replaces missing values
(Also similar to <a href="https://github.com/tidyverse/tidyr/issues/183" class="external-link uri">https://github.com/tidyverse/tidyr/issues/183</a>)</p></li>
<li><p>upsert — update or insert depending on presence/absence of
keys</p></li>
</ul>
<p>All operations would either take multiple named inputs or a single
unnamed data frame. Additional restrictions and options may apply on
other backends, these will be specified with arguments that start with a
dot. For extensibility, named inputs that start with a dot are silently
discarded.</p>
<p>All operations require specification of a <code>.key</code> argument.
Unlike <code>by</code> with joins, the <code>.key</code> argument is
mandatory, because RHS column names must be a subset of the LHS column
names. Keys must have the same name in the target and the input. If the
table container knows its keys (e.g., grouped data frames or
data.table), <code>.key</code> may be omitted.</p>
<p>Both target table and source columns/table must be compatible:</p>
<ul>
<li>Source has no extra tables and columns.</li>
<li>Key columns must be present in source.</li>
</ul>
</div>
<div class="section level3">
<h3 id="mutable-backends">Mutable backends<a class="anchor" aria-label="anchor" href="#mutable-backends"></a>
</h3>
<p>Some <em>mutable</em> backends, most notably databases, Google sheets
and data.table, permit in-place update of the source data. Update
operations on mutable backends should optionally allow updating the
source data. Because this is a potentially destructive exception from
the dplyr guarantees, in-place updates must be “opt in”. The default
result always will be a “lazy” table. This allows previewing the results
of an update operation before materializing.</p>
<p>On these backends, the following additional operations are
useful:</p>
<ul>
<li><p>delete — remove rows that match keys, a variant of
<code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join()</a></code></p></li>
<li><p>truncate — remove all rows</p></li>
</ul>
<p>Databases will require that the data is already on the database or
ask the user to supply a <code>copy</code> argument.</p>
<p>On mutable backends, update operations return the input, invisibly,
if the update was carried out in-place.</p>
<p>Challenges:</p>
<ul>
<li>How to make compatible with <code>sql_render()</code>?</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="dm">dm<a class="anchor" aria-label="anchor" href="#dm"></a>
</h2>
<p>Operations on a dm object are generally transient or ephemeral.
Resulting dm or table objects must be stored in a new object, otherwise
they are lost.</p>
<div class="section level3">
<h3 id="design">Design<a class="anchor" aria-label="anchor" href="#design"></a>
</h3>
<ul>
<li>records from tables from a source dm are
appended/updated/upserted/removed/replaced/… from the target dm</li>
<li>both dm must be compatible
<ul>
<li>same source</li>
<li>source is a subset of target tables</li>
</ul>
</li>
<li>dry run supported: use transient operations instead of
materialization
<ul>
<li>check integrity constraints are still valid after running</li>
<li>compare before-after state</li>
</ul>
</li>
<li>transactions out of scope, caller can use
<code>DBI::withTransaction()</code>
</li>
<li>some operations need top-down, others need bottom-up
<ul>
<li>fixed set of operations, each op knows its “direction”</li>
</ul>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="logic-of-operation">Logic of operation<a class="anchor" aria-label="anchor" href="#logic-of-operation"></a>
</h3>
<ul>
<li>check compatibility</li>
<li>persist tables one by one, topologically sorted</li>
<li>put back into dm if necessary</li>
</ul>
</div>
<div class="section level3">
<h3 id="api-draft">API draft<a class="anchor" aria-label="anchor" href="#api-draft"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm_insert</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_insert</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_update</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_upsert</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_upsert</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_delete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_delete</span>, top_down <span class="op">=</span> <span class="cn">FALSE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_truncate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_truncate</span>, top_down <span class="op">=</span> <span class="cn">FALSE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">dm_check_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">dm_run_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_check_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">target_dm</span><span class="op">)</span></span>
<span>  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">check_same_src</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span></span>
<span>  <span class="fu">walk2</span><span class="op">(</span><span class="fu"><a href="../../reference/dm_get_tables.html">dm_get_tables</a></span><span class="op">(</span><span class="va">target_dm</span><span class="op">)</span>, <span class="fu"><a href="../../reference/dm_get_tables.html">dm_get_tables</a></span><span class="op">(</span><span class="va">dm</span><span class="op">)</span>, <span class="va">check_columns_superset</span><span class="op">)</span></span>
<span>  <span class="fu">check_keys_compatible</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_run_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># topologically sort tables</span></span>
<span>  <span class="co"># run operation(target_tbl, source_tbl, dry_run = dry_run) for each table</span></span>
<span>  <span class="co"># operation() always returns tbl, only need to patch if not the same tbl</span></span>
<span>  <span class="co"># new_tables is list of non-NULL operation() values</span></span>
<span></span>
<span>  <span class="va">target_dm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dm_patch_tbl</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">new_tables</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dm_patch_tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dm</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">new_tables</span> <span class="op">&lt;-</span> <span class="fu">list2</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># FIXME: Better error message for unknown tables</span></span>
<span></span>
<span>  <span class="va">def</span> <span class="op">&lt;-</span> <span class="fu">dm_get_def</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span></span>
<span>  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">new_tables</span><span class="op">)</span>, <span class="va">def</span><span class="op">$</span><span class="va">table</span><span class="op">)</span></span>
<span>  <span class="va">def</span><span class="op">[</span><span class="va">idx</span>, <span class="st">"data"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">new_tables</span><span class="op">)</span></span>
<span>  <span class="fu">dm_from_def</span><span class="op">(</span><span class="va">def</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://cynkra.com/about/" class="external-link">Tobias Schieferdecker</a>, <a href="http://krlmlr.info" class="external-link">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch/de/" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/energie-72.png" height="16" alt="energie360° AG"></a>, <a href="https://www.cynkra.com" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/cynkra-72.png" height="16" alt="cynkra GmbH"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>
Sponsored by <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-footer" alt="cynkra"></a>
</p>
</div>

    </footer>
</div>





  </body>
</html>
