<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Copy tables to and from a database • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Fira_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Copy tables to and from a database">
<meta name="robots" content="noindex">
<script defer data-domain="dm.cynkra.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-nav" alt="cynkra"></a>
    <a class="navbar-brand me-2" href="../index.html">dm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.10.9010</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dm.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/howto-dm-theory.html">Introduction to relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-df.html">Create a dm object from data frames</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-db.html">Create a dm object from a database</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-copy.html">Copy data to and from a database</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-rows.html">Insert, update, or remove rows in a database</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/cheatsheet.html">Cheatsheet</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical-articles">
<li><a class="dropdown-item" href="../articles/tech-dm-draw.html">Visualizing dm objects</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-keyed.html">Manipulating individual tables</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-join.html">Joining in relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-filter.html">Filtering in relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-zoom.html">Zooming and manipulating tables</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-low-level.html">Model verification - keys, constraints and normalization</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-class.html">Class 'dm' and basic operations</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-naming.html">Function naming logic</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-cdm.html">Migration guide: 'cdm' -&gt; 'dm'</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cynkra/dm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Copy tables to and from a database</h1>
                        <h4 data-toc-skip class="author">James
Wondrasek, Kirill Müller</h4>
            
            <h4 data-toc-skip class="date">2024-08-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cynkra/dm/blob/main/vignettes/howto-dm-copy.Rmd" class="external-link"><code>vignettes/howto-dm-copy.Rmd</code></a></small>
      <div class="d-none name"><code>howto-dm-copy.Rmd</code></div>
    </div>

    
    
<p>In this tutorial, we introduce {dm} methods and techniques for
copying individual tables and entire relational data models into a
relational database management system (RDBMS). This is an integral part
of the {dm} workflow. Copying tables to an RDBMS is often a step in the
process of building a relational data model from locally hosted data. If
your data model is complete, copying it to an RDBMS in a single
operation allows you to leverage the power of the database and make it
accessible to others. For modifying and persisting changes to your data
at the row-level see <code><a href="../articles/howto-dm-rows.html">vignette("howto-dm-rows")</a></code>.</p>
<div class="section level2">
<h2 id="copy-models-or-copy-tables">Copy models or copy tables?<a class="anchor" aria-label="anchor" href="#copy-models-or-copy-tables"></a>
</h2>
<p>Using {dm} you can persist an entire relational data model with a
single function call. <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> will move your entire
model into a destination RDBMS. This may be all you need to deploy a new
model. You may want to add new tables to an existing model on an RDBMS.
These requirements can be handled using the <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> and
<code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> methods.</p>
<p>Calling <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> or <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> requires
write permission on the RDBMS; otherwise, an error is returned.
Therefore, for the following examples, we will instantiate a test
<code>dm</code> object and move it into a local SQLite database with
full permissions. {dm} and {dbplyr} are designed to treat the code used
to manipulate a <strong>local</strong> SQLite database and a
<strong>remote</strong> RDBMS similarly. The steps for this were already
introduced in <code><a href="../articles/howto-dm-db.html">vignette("howto-dm-db")</a></code> and will be discussed
in more detail in the <a href="#copy-model">Copying a relational
model</a> section.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dm.cynkra.com/">dm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fin_dm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/dm_financial.html">dm_financial</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_select_tbl.html">dm_select_tbl</a></span><span class="op">(</span><span class="op">-</span><span class="va">trans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `financial_db_con()` at dm/R/financial.R:18:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't connect to relational.fit.cvut.cz or databases.pacha.dev:</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'relational.fit.cvut.cz:3306' (101)</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'databases.pacha.dev:3306' (110)</span></span>
<span></span>
<span><span class="va">local_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">deployed_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/copy_dm_to.html">copy_dm_to</a></span><span class="op">(</span><span class="va">local_db</span>, <span class="va">fin_dm</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'fin_dm' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="copying-tables">Copying and persisting individual tables<a class="anchor" aria-label="anchor" href="#copying-tables"></a>
</h2>
<p>As part of your data analysis, you may combine tables from multiple
sources and create links to existing tables via foreign keys, or create
new tables holding data summaries. The example below, already discussed
in <code><a href="../articles/howto-dm-db.html">vignette("howto-dm-db")</a></code>, computes the total amount of
all loans for each account.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">deployed_dm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span><span class="op">(</span><span class="va">loans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">account_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>total_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">amount</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span><span class="op">(</span><span class="st">"total_loans"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span></code></pre></div>
<p>The derived table <code>total_loans</code> is a <em>lazy table</em>
powered by the {<a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a>}
package: the results are not materialized, instead an SQL query is built
and executed each time the data is requested.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span><span class="op">$</span><span class="va">total_loans</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
<p>To avoid recomputing the query every time you use
<code>total_loans</code>, call <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> right before
inserting the derived table with <code>dm_insert_tbl()</code>.
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> forces the computation of a query and stores the
full results in a table on the RDBMS.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total_computed</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">deployed_dm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span><span class="op">(</span><span class="va">loans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">account_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>total_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">amount</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span><span class="op">(</span><span class="st">"total_loans"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span>
<span></span>
<span><span class="va">my_dm_total_computed</span><span class="op">$</span><span class="va">total_loans</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total_computed' not found</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total_computed' not found</span></span></code></pre>
<p>Note the differences in queries returned by
<code><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render()</a></code>. <code>my_dm_total$total_loans</code> is still
being lazily evaluated and the full query constructed from the chain of
operations that generated it is still in place and needs to be run to
access it. Contrast that with
<code>my_dm_total_computed$total_loans</code>, where the query has been
realized and accessing its rows requires a simple <code>SELECT *</code>
statement. The table name, <code>dbplyr_001</code>, was automatically
generated as the <code>name</code> argument was not supplied to
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code>.</p>
<p>The default is to create a <strong>temporary</strong> tables. If you
want results to persist across sessions in <strong>permanent</strong>
tables, <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> must be called with the argument
<code>temporary = FALSE</code> and a table name for the
<code>name</code> argument. See <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">?compute</a></code> for more
details.</p>
<p>When called on a whole <code>dm</code> object (without zoom),
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> materializes all tables into new temporary tables
by executing the associated SQL query and storing the full results.
Depending on the size of your data, this may take considerable time or
may even be infeasible. It may be useful occasionally to create
snapshots of data that is subject to change.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total_snapshot</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">my_dm_total</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-frames">Adding local data frames to an RDBMS<a class="anchor" aria-label="anchor" href="#data-frames"></a>
</h2>
<p>If you need to add local data frames to an existing <code>dm</code>
object, use the <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> method. It takes the same
arguments as <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>, except the second argument takes
a data frame rather than a dm. The result is a derived <code>dm</code>
object that contains the new table.</p>
<p>To demonstrate the use of <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code>, the example below
will use {dm} to pull consolidated data from several tables out of an
RDBMS, estimate a linear model from the data, then insert the residuals
back into the RDBMS and link it to the existing tables. This is all done
with a local SQLite database, but the process would work unchanged on
any supported RDBMS.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loans_df</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">deployed_dm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span><span class="op">(</span><span class="va">loans</span>, .recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">amount</span>, <span class="va">duration</span>, <span class="va">A3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span></code></pre></div>
<p>Please note the use of <code>recursive = TRUE</code> for
<code><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl()</a></code>. This method gathers all linked
information into a single wide table. It follows foreign key relations
starting from the table supplied as its argument and gathers all the
columns from related tables, disambiguating column names as it goes.</p>
<p>In the above code, the <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code> statement isolates the
columns we need for our model. <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> works similarly to
<code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> by forcing the execution of the underlying SQL
query, but it returns the results as a local tibble.</p>
<p>Below, the local tibble, <code>loans_df</code>, is used to estimate
the linear model and the residuals are stored along with the original
associated <code>id</code> in a new tibble,
<code>loans_residuals</code>. The <code>id</code> column is necessary to
link the new tibble to the tables in the dm it was collected from.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">amount</span> <span class="op">~</span> <span class="va">duration</span> <span class="op">+</span> <span class="va">A3</span>, data <span class="op">=</span> <span class="va">loans_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(mf, parent.frame()): object 'loans_df' not found</span></span>
<span></span>
<span><span class="va">loans_residuals</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="va">loans_df</span><span class="op">$</span><span class="va">id</span>,</span>
<span>  resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: object 'loans_df' not found</span></span>
<span></span>
<span><span class="va">loans_residuals</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'loans_residuals' not found</span></span></code></pre></div>
<p>Adding <code>loans_residuals</code> to the dm is done using
<code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code>. The call to the method includes the argument
<code>temporary = FALSE</code> because we want this table to persist
beyond our current session. In the same pipeline we create the necessary
primary and foreign keys to integrate the table with the rest of our
relational model. For more information on key creation, see
<code><a href="../articles/howto-dm-db.html">vignette("howto-dm-db")</a></code> and
<code><a href="../articles/howto-dm-theory.html">vignette("howto-dm-theory")</a></code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_sqlite_resid</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to</a></span><span class="op">(</span><span class="va">deployed_dm</span>, <span class="va">loans_residuals</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span><span class="op">(</span><span class="va">loans_residuals</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span><span class="op">(</span><span class="va">loans_residuals</span>, <span class="va">id</span>, <span class="va">loans</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span>
<span></span>
<span><span class="va">my_dm_sqlite_resid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_set_colors.html">dm_set_colors</a></span><span class="op">(</span>violet <span class="op">=</span> <span class="va">loans_residuals</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_sqlite_resid' not found</span></span>
<span><span class="va">my_dm_sqlite_resid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_examine_constraints.html">dm_examine_constraints</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_sqlite_resid' not found</span></span>
<span><span class="va">my_dm_sqlite_resid</span><span class="op">$</span><span class="va">loans_residuals</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_sqlite_resid' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="copy-model">Persisting a relational model with <code>copy_dm_to()</code><a class="anchor" aria-label="anchor" href="#copy-model"></a>
</h2>
<p>Persistence, because it is intended to make permanent changes,
requires write access to the source RDBMS. The code below is a repeat of
the code that opened the <a href="#copying-tables">Copying and
persisting individual tables</a> section at the beginning of the
tutorial. It uses the {dm} convenience function
<code><a href="../reference/dm_financial.html">dm_financial()</a></code> to create a dm object corresponding to a
data model from a public dataset repository. The dm object is downloaded
locally first, before deploying it to a local SQLite database.</p>
<p><code><a href="../reference/dm_select_tbl.html">dm_select_tbl()</a></code> is used to exclude the transaction table
<code>trans</code> due to its size, then the <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code>
method retrieves the remaining tables and returns them as a local dm
object.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dm_financial.html">dm_financial</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_nrow.html">dm_nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `financial_db_con()` at dm/R/financial.R:18:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't connect to relational.fit.cvut.cz or databases.pacha.dev:</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'relational.fit.cvut.cz:3306' (101)</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'databases.pacha.dev:3306' (110)</span></span>
<span><span class="va">fin_dm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/dm_financial.html">dm_financial</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_select_tbl.html">dm_select_tbl</a></span><span class="op">(</span><span class="op">-</span><span class="va">trans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `financial_db_con()` at dm/R/financial.R:18:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't connect to relational.fit.cvut.cz or databases.pacha.dev:</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'relational.fit.cvut.cz:3306' (101)</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'databases.pacha.dev:3306' (110)</span></span>
<span></span>
<span><span class="va">fin_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'fin_dm' not found</span></span></code></pre></div>
<p>It is just as simple to move a local relational model into an
RDBMS.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">destination_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">deployed_dm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/copy_dm_to.html">copy_dm_to</a></span><span class="op">(</span><span class="va">destination_db</span>, <span class="va">fin_dm</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'fin_dm' not found</span></span>
<span></span>
<span><span class="va">deployed_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span></code></pre></div>
<p>Note that in the call to <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> the argument
<code>temporary = FALSE</code> is supplied. Without this argument, the
model would still be copied into the database, but the argument would
default to <code>temporary = TRUE</code> and the data would be deleted
once your session ends.</p>
<p>In the output you can observe that the <code>src</code> for
<code>deployed_dm</code> is SQLite, while for <code>fin_dm</code> the
source is not indicated because it is a local data model.</p>
<p>Copying a relational model into an empty database is the simplest use
case for <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>. If you want to copy a model into an
RDBMS that is already populated, be aware that <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>
will not overwrite pre-existing tables. In this case you will need to
use the <code>table_names</code> argument to give the tables unique
names.</p>
<p><code>table_names</code> can be a named character vector, with the
names matching the table names in the dm object and the values
containing the desired names in the RDBMS, or a function or one-sided
formula. In the example below, <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0()</a></code> is used to add a
prefix to the table names to provide uniqueness.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dup_dm</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/copy_dm_to.html">copy_dm_to</a></span><span class="op">(</span><span class="va">destination_db</span>, <span class="va">fin_dm</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span>, table_names <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"dup_"</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'fin_dm' not found</span></span>
<span></span>
<span><span class="va">dup_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'dup_dm' not found</span></span>
<span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/remote_name.html" class="external-link">remote_name</a></span><span class="op">(</span><span class="va">dup_dm</span><span class="op">$</span><span class="va">accounts</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'dup_dm' not found</span></span>
<span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/remote_name.html" class="external-link">remote_name</a></span><span class="op">(</span><span class="va">deployed_dm</span><span class="op">$</span><span class="va">accounts</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span></code></pre></div>
<p>Note the different table names for <code>dup_dm$accounts</code> and
<code>deployed_dm$accounts</code>. For both, the table name is
<code>accounts</code> in the <code>dm</code> object, but they link to
different tables on the database. In <code>dup_dm</code>, the table is
backed by the table <code>dup_accounts</code> in the RDBMS.
<code>dm_deployed$accounts</code> shows us that this table is still
backed by the <code>accounts</code> table from the
<code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> operation we performed in the preceding
example.</p>
<p>Managing tables in the RDBMS is outside the scope of <code>dm</code>.
If you find you need to remove tables or perform operations directly on
the RDBMS, see the {<a href="https://dbi.r-dbi.org/" class="external-link">DBI</a>}
package.</p>
<p>When done, do not forget to disconnect:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">destination_db</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">local_db</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p><code>dm</code> makes it straightforward to deploy your complete
relational model to an RDBMS using the <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>
function. For tables that are created from a relational model during
analysis or development, <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> and
<code><a href="https://dplyr.tidyverse.org/reference/copy_to.html" class="external-link">copy_to()</a></code> can be used to persist them (using argument
<code>temporary = FALSE</code>) between sessions or to copy local tables
to a database <code>dm</code>. The <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> method
downloads an entire <code>dm</code> object that fits into memory from
the database.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p>If you need finer-grained control over modifications to your
relational model, see <code><a href="../articles/howto-dm-rows.html">vignette("howto-dm-rows")</a></code> for an
introduction to row level operations, including updates, insertions,
deletions and patching.</p>
<p>If you would like to know more about relational data models in order
to get the most out of dm, check out
<code><a href="../articles/howto-dm-theory.html">vignette("howto-dm-theory")</a></code>.</p>
<p>If you’re familiar with relational data models but want to know how
to work with them in dm, then any of
<code><a href="../articles/tech-dm-join.html">vignette("tech-dm-join")</a></code>,
<code><a href="../articles/tech-dm-filter.html">vignette("tech-dm-filter")</a></code>, or
<code><a href="../articles/tech-dm-zoom.html">vignette("tech-dm-zoom")</a></code> is a good next step.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://cynkra.com/about/" class="external-link">Tobias Schieferdecker</a>, <a href="http://krlmlr.info" class="external-link">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch/de/" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/energie-72.png" height="16" alt="energie360° AG"></a>, <a href="https://www.cynkra.com" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/cynkra-72.png" height="16" alt="cynkra GmbH"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>
Sponsored by <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-footer" alt="cynkra"></a>
</p>
</div>

    </footer>
</div>





  </body>
</html>
