<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Create a dm object from a database • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Fira_Mono-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Create a dm object from a database">
<meta name="robots" content="noindex">
<script defer data-domain="dm.cynkra.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-nav" alt="cynkra"></a>
    <a class="navbar-brand me-2" href="../index.html">dm</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.10.9010</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dm.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><a class="dropdown-item" href="../articles/howto-dm-theory.html">Introduction to relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-df.html">Create a dm object from data frames</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-db.html">Create a dm object from a database</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-copy.html">Copy data to and from a database</a></li>
    <li><a class="dropdown-item" href="../articles/howto-dm-rows.html">Insert, update, or remove rows in a database</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/cheatsheet.html">Cheatsheet</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical-articles">
<li><a class="dropdown-item" href="../articles/tech-dm-draw.html">Visualizing dm objects</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-keyed.html">Manipulating individual tables</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-join.html">Joining in relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-filter.html">Filtering in relational data models</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-zoom.html">Zooming and manipulating tables</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-low-level.html">Model verification - keys, constraints and normalization</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-class.html">Class 'dm' and basic operations</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-naming.html">Function naming logic</a></li>
    <li><a class="dropdown-item" href="../articles/tech-dm-cdm.html">Migration guide: 'cdm' -&gt; 'dm'</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cynkra/dm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Create a dm object from a database</h1>
                        <h4 data-toc-skip class="author">James
Wondrasek, Kirill Müller</h4>
            
            <h4 data-toc-skip class="date">2024-08-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/cynkra/dm/blob/main/vignettes/howto-dm-db.Rmd" class="external-link"><code>vignettes/howto-dm-db.Rmd</code></a></small>
      <div class="d-none name"><code>howto-dm-db.Rmd</code></div>
    </div>

    
    
<p>{dm} was designed to make connecting to and working with a relational
database management system (RDBMS) as straightforward as possible. To
this end, a dm object can be created from any database that has a {<a href="https://dbi.r-dbi.org/" class="external-link">DBI</a>} backend available (<a href="https://github.com/r-dbi/backends" class="external-link">see list</a>).</p>
<p>When a dm object is created via a DBI connection to an RDBMS, it can
import all the tables in the database, the active schema, or a limited
set. For some RDBMS, such as Postgres, SQL Server and MariaDB, primary
and foreign keys are also imported and do not have to be manually added
afterwards.</p>
<p>To demonstrate, we will connect to a <a href="https://relational.fit.cvut.cz/" class="external-link">relational dataset repository</a>
with a database server that is publicly accessible without registration.
It hosts a <a href="https://relational.fit.cvut.cz/dataset/Financial" class="external-link">financial
dataset</a> that contains loan data along with relevant account
information and transactions. We chose this dataset because the
relationships between <code>loan</code>, <code>account</code>, and
<code>transactions</code> tables are a good representation of databases
that record real-world business transactions.</p>
<p>Below, we open a connection to the publicly accessible database
server using their documented connection parameters. Connection details
vary from database to database. Before connecting to your own RDBMS, you
may want to read <code><a href="https://dbi.r-dbi.org/articles/DBI.html" class="external-link">vignette("DBI", package = "DBI")</a></code> for
further information.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rmariadb.r-dbi.org" class="external-link">RMariaDB</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"relational"</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"Financial_ijs"</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"relational.fit.cvut.cz"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `dm:::financial_db_con()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't connect to relational.fit.cvut.cz or databases.pacha.dev:</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'relational.fit.cvut.cz:3306' (101)</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'databases.pacha.dev:3306' (110)</span></span></code></pre>
<p>Creating a dm object takes a single call to
<code><a href="../reference/dm_from_con.html">dm_from_con()</a></code> with the DBI connection object as its
argument.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dm.cynkra.com/">dm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm_from_con.html">dm_from_con</a></span><span class="op">(</span><span class="va">my_db</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_db' not found</span></span>
<span><span class="va">my_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm' not found</span></span></code></pre></div>
<p>The components of the <code>my_dm</code> object are lazy tables
powered by {<a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a>}.
{dbplyr} translates the {<a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a>} grammar of data
manipulation into queries the database server understands. Lazy tables
defer downloading of table data until results are required for printing
or local processing.</p>
<div class="section level2">
<h2 id="building-a-dm-from-a-subset-of-tables">Building a dm from a subset of tables<a class="anchor" aria-label="anchor" href="#building-a-dm-from-a-subset-of-tables"></a>
</h2>
<p>A dm can also be constructed from individual tables or views. This is
useful for when you want to work with a subset of a database’s tables,
perhaps from different schemas.</p>
<p>Below, we use the <code>$</code> notation to extract two tables from
the financial database. Then we create our dm by passing the tables in
as arguments. Note that the tables arguments have to all be from the
same source, in this case <code>my_db</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">my_db</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbListTables': object 'my_db' not found</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a></span><span class="op">)</span></span>
<span><span class="va">loans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">my_db</span>, <span class="st">"loans"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_db' not found</span></span>
<span><span class="va">accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">my_db</span>, <span class="st">"accounts"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_db' not found</span></span>
<span></span>
<span><span class="va">my_manual_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm.html">dm</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">accounts</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `map()` at dm/R/dm.R:58:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In index: 1.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> object 'loans' not found</span></span>
<span><span class="va">my_manual_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_manual_dm' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-primary-and-foreign-keys">Defining Primary and Foreign Keys<a class="anchor" aria-label="anchor" href="#defining-primary-and-foreign-keys"></a>
</h2>
<p>Primary keys and foreign keys are how relational database tables are
linked with each other. A primary key is a column or column tuple that
has a unique value for each row within a table. A foreign key is a
column or column tuple containing the primary key for a row in another
table. Foreign keys act as cross references between tables. They specify
the relationships that gives us the <em>relational</em> database. For
more information on keys and a crash course on databases, see
<code><a href="../articles/howto-dm-theory.html">vignette("howto-dm-theory")</a></code>.</p>
<p>In many cases, <code><a href="../reference/dm_from_con.html">dm_from_con()</a></code> already returns a dm with
all keys set. If not, dm allows us to define primary and foreign keys
ourselves. For this, we use <code>learn_keys = FALSE</code> to obtain a
<code>dm</code> object with only the tables.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dm.cynkra.com/">dm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">fin_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm_from_con.html">dm_from_con</a></span><span class="op">(</span><span class="va">my_db</span>, learn_keys <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_db' not found</span></span>
<span><span class="va">fin_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'fin_dm' not found</span></span></code></pre></div>
<p>The <a href="https://relational.fit.cvut.cz/assets/img/datasets-generated/financial.svg" class="external-link">model
diagram</a> provided by our test database loosely illustrates the
intended relationships between tables. In the diagram, we can see that
the <code>loans</code> table should be linked to the
<code>accounts</code> table. Below, we create those links in 3
steps:</p>
<ol style="list-style-type: decimal">
<li>Add a primary key <code>id</code> to the <code>accounts</code>
table</li>
<li>Add a primary key <code>id</code> to the <code>loans</code>
table</li>
<li>Add a foreign key <code>account_id</code> to the <code>loans</code>
table referencing the <code>accounts</code> table</li>
</ol>
<p>Then we assign colors to the tables and draw the structure of the
dm.</p>
<p>Note that when the foreign key is created, the primary key in the
referenced table does not need to be <em>specified</em>, but the primary
key must already be <em>defined</em>. And, as mentioned above, primary
and foreign key constraints on the database are currently only imported
for Postgres, SQL Server databases and MariaDB, and only when
<code><a href="../reference/dm_from_con.html">dm_from_con()</a></code> is used. This process of key definition needs
to be done manually for other databases.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_keys</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">my_manual_dm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span><span class="op">(</span><span class="va">accounts</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">account_id</span>, <span class="va">accounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_set_colors.html">dm_set_colors</a></span><span class="op">(</span>green <span class="op">=</span> <span class="va">loans</span>, orange <span class="op">=</span> <span class="va">accounts</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_manual_dm' not found</span></span>
<span></span>
<span><span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span></code></pre></div>
<p>Once you have instantiated a dm object, you can continue to add
tables to it. For tables from the original source for the dm, use
<code><a href="../reference/dm.html">dm()</a></code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">my_db</span>, <span class="st">"trans"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_db' not found</span></span>
<span></span>
<span><span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm.html">dm</a></span><span class="op">(</span><span class="va">trans</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `map()` at dm/R/dm.R:58:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In index: 1.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> object 'my_dm_keys' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="serializing-a-dm-object">Serializing a dm object<a class="anchor" aria-label="anchor" href="#serializing-a-dm-object"></a>
</h2>
<p>A dm object is always linked to a database connection. This
connection is lost when the dm object is saved to disk, e.g., when
saving the workspace in R or in Posit Workbench, or when using knitr
chunks:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">unserialize</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">my_dm_keys</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span></code></pre></div>
<p>The connection is tightly coupled with the tables in the dm object
and cannot be replaced. A practical solution is to define, for each dm
object your project uses, a function that recreates it using a new
database connection:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_db_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">dbConnect</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html" class="external-link">MariaDB</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    username <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>    password <span class="op">=</span> <span class="st">"relational"</span>,</span>
<span>    dbname <span class="op">=</span> <span class="st">"Financial_ijs"</span>,</span>
<span>    host <span class="op">=</span> <span class="st">"relational.fit.cvut.cz"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">my_dm_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">my_db</span> <span class="op">=</span> <span class="fu">my_db_fun</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">loans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">my_db</span>, <span class="st">"loans"</span><span class="op">)</span></span>
<span>  <span class="va">accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html" class="external-link">tbl</a></span><span class="op">(</span><span class="va">my_db</span>, <span class="st">"accounts"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/dm.html">dm</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">accounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span><span class="op">(</span><span class="va">accounts</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span><span class="op">(</span><span class="va">loans</span>, <span class="va">account_id</span>, <span class="va">accounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/dm_set_colors.html">dm_set_colors</a></span><span class="op">(</span>green <span class="op">=</span> <span class="va">loans</span>, orange <span class="op">=</span> <span class="va">accounts</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `dm:::financial_db_con()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't connect to relational.fit.cvut.cz or databases.pacha.dev:</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'relational.fit.cvut.cz:3306' (101)</span></span>
<span><span class="co">#&gt; Failed to connect: Can't connect to MySQL server on 'databases.pacha.dev:3306' (110)</span></span></code></pre>
<p>To avoid reconnecting and/or recreating every time you need a dm
object, you can use <code><a href="https://memoise.r-lib.org/reference/memoise.html" class="external-link">memoise::memoise()</a></code> to memoize the
connection and/or dm functions.</p>
</div>
<div class="section level2">
<h2 id="transient-nature-of-operations">Transient nature of operations<a class="anchor" aria-label="anchor" href="#transient-nature-of-operations"></a>
</h2>
<p>Like other R objects, a dm is immutable and all operations performed
on it are transient unless stored in a new variable.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_keys</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span>
<span></span>
<span><span class="va">my_dm_trans</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm.html">dm</a></span><span class="op">(</span><span class="va">trans</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `map()` at dm/R/dm.R:58:3:</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> In index: 1.</span></span>
<span><span class="co">#&gt; <span style="font-weight: bold;">Caused by error:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> object 'my_dm_keys' not found</span></span>
<span></span>
<span><span class="va">my_dm_trans</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_trans' not found</span></span></code></pre></div>
<p>And, like {dbplyr}, results are never written to a database unless
explicitly requested.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span><span class="op">(</span><span class="va">loans</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span>
<span></span>
<span><span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span><span class="op">(</span><span class="va">loans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="performing-operations-on-tables-by-zooming">Performing operations on tables by “zooming”<a class="anchor" aria-label="anchor" href="#performing-operations-on-tables-by-zooming"></a>
</h2>
<p>As the dm is a collection of tables, if we wish to perform operations
on an individual table, we set it as the context for those operations
using <code><a href="../reference/dm_zoom_to.html">dm_zoom_to()</a></code>. See
<code><a href="../articles/tech-dm-zoom.html">vignette("tech-dm-zoom")</a></code> for more detail on zooming.</p>
<p>dm operations are transient unless persistence is explicitly
requested. To make our chain of manipulations on the selected table
permanent, we assign the result of <code><a href="../reference/dm_zoom_to.html">dm_insert_zoomed()</a></code> to a
new object, <code>my_dm_total</code>. This is a new dm object, derived
from <code>my_dm_keys</code>, with a new lazy table
<code>total_loans</code> linked to the <code>accounts</code> table.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">my_dm_keys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span><span class="op">(</span><span class="va">loans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">account_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>total_amount <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">amount</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span><span class="op">(</span><span class="st">"total_loans"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span></span></code></pre></div>
<p>Context is set to the table “loans” using
<code>dm_zoom_to(loans)</code>. You can learn more about zooming in the
tutorial <code><a href="../articles/tech-dm-zoom.html">vignette("tech-dm-zoom")</a></code>. We then use {<a href="https://dplyr.tidyverse.org/" class="external-link">dplyr</a>} functions on the zoomed
table to generate a new summary table.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize()</a></code> returns a temporary table with one row for
each group created by the preceding <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> function.
The columns in the temporary table are constrained to the columns passed
as arguments to the <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> function and the column(s)
created by the <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize()</a></code> function.</p>
<p><code>dm_insert_zoomed("total_loans")</code> adds the temporary table
created by <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize()</a></code> to the data model under a new name,
<code>total_loans</code>. Because the grouping variable
<code>account_id</code> is a primary key, the new derived table is
automatically linked to the <code>accounts</code> table.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_set_colors.html">dm_set_colors</a></span><span class="op">(</span>violet <span class="op">=</span> <span class="va">total_loans</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
<p>The resulting table <code>total_loans</code> can be accessed like any
other table in the dm object.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span><span class="op">$</span><span class="va">total_loans</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
<p>It is a <em>lazy table</em> powered by the {<a href="https://dbplyr.tidyverse.org/" class="external-link">dbplyr</a>} package: the results
are not materialized; instead, an SQL query is built and executed each
time the data is requested.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span><span class="op">$</span><span class="va">total_loans</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html" class="external-link">sql_render</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
<p>Use <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute()</a></code> on a zoomed table to materialize it to a
temporary table and avoid recomputing. See
<code><a href="../articles/howto-dm-copy.html">vignette("howto-dm-copy")</a></code> for more details.</p>
</div>
<div class="section level2">
<h2 id="downloading-data">Downloading data<a class="anchor" aria-label="anchor" href="#downloading-data"></a>
</h2>
<p>When it becomes necessary to move data locally for analysis or
reporting, the {dm} method <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> is used. Operations on
dm objects for databases are limited to report only the first ten
results. <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> forces the evaluation of all SQL queries
and the generation of the complete set of results. The resulting tables
are transferred from the RDBMS and stored as local tibbles.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_local</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">my_dm_total</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span>
<span></span>
<span><span class="va">my_dm_local</span><span class="op">$</span><span class="va">total_loans</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_local' not found</span></span></code></pre></div>
<p>Use this method with caution. If you are not sure of the size of the
dataset you will be downloading, you can call <code><a href="../reference/dm_nrow.html">dm_nrow()</a></code> on
your <code>dm</code> for the row count of your data model’s tables.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dm_total</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/dm_nrow.html">dm_nrow</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="persist">Persisting results<a class="anchor" aria-label="anchor" href="#persist"></a>
</h2>
<p>It is just as simple to move a local relational model into an RDBMS
as is using <code><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect()</a></code> to download it. The method used is
<code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> and it takes as arguments a database
connection and a dm object. In the example below, a local SQLite
database is used to demonstrate it, but {dm} is designed to work with
any RDBMS supported by {DBI}.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">destination_db</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html" class="external-link">SQLite</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">deployed_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/copy_dm_to.html">copy_dm_to</a></span><span class="op">(</span><span class="va">destination_db</span>, <span class="va">my_dm_local</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_local' not found</span></span>
<span></span>
<span><span class="va">deployed_dm</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'deployed_dm' not found</span></span>
<span><span class="va">my_dm_local</span></span>
<span><span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_local' not found</span></span></code></pre></div>
<p>In the output, you can observe that the <code>src</code> for
<code>deployed_dm</code> is the SQLite database, while for
<code>my_dm_local</code> the source is the local R environment.</p>
<p>Persisting tables are covered in more detail in
<code><a href="../articles/howto-dm-copy.html">vignette("howto-dm-copy")</a></code>.</p>
<p>When done, do not forget to disconnect:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">destination_db</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">my_db</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbDisconnect': object 'my_db' not found</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>In this tutorial, we have demonstrated how simple it is to load a
database into a <code>dm</code> object and begin working with it.
Currently, loading a dm from most RDBMS requires you to manually set key
relations, but {dm} provides methods to make this straightforward. It is
planned that future versions of dm will support automatic key creation
for more RDBMS.</p>
<p>The next step is to read <code><a href="../articles/howto-dm-copy.html">vignette("howto-dm-copy")</a></code>,
where copying your tables to and from an RDBMS is covered.
<code><a href="../articles/howto-dm-rows.html">vignette("howto-dm-rows")</a></code> discusses manipulation of
individual rows in a database.</p>
</div>
<div class="section level2">
<h2 id="further-reading">Further reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<p><code><a href="../articles/howto-dm-df.html">vignette("howto-dm-df")</a></code> – Is your data in local data
frames? This article covers creating a data model from your local data
frames, including building the relationships in your data model,
verifying your model, and leveraging the power of dplyr to operate on
your data model.</p>
<p><code><a href="../articles/howto-dm-theory.html">vignette("howto-dm-theory")</a></code> – Do you know all about data
frames but very little about relational data models? This quick
introduction will walk you through the key similarities and differences,
and show you how to move from individual data frames to a relational
data model.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://cynkra.com/about/" class="external-link">Tobias Schieferdecker</a>, <a href="http://krlmlr.info" class="external-link">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch/de/" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/energie-72.png" height="16" alt="energie360° AG"></a>, <a href="https://www.cynkra.com" class="external-link"><img src="https://cynkra.github.io/dm/reference/figures/cynkra-72.png" height="16" alt="cynkra GmbH"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>
Sponsored by <a href="https://cynkra.com" class="external-link"><img src="https://cynkra.com/assets/img/logo_small.svg" id="cynkra-logo-footer" alt="cynkra"></a>
</p>
</div>

    </footer>
</div>





  </body>
</html>
